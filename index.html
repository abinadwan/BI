<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>حساب ربح المقاول | Contractor Profit Calculator</title>

<!-- External libs (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg: #ffffff; --fg:#111827; --muted:#6b7280; --card:#f3f4f6; --border:#e5e7eb;
  --primary:#2563eb; --accent:#10b981; --danger:#ef4444; --warn:#f59e0b;
}
:root.dark{
  --bg:#0b0f14; --fg:#e5e7eb; --muted:#94a3b8; --card:#0f172a; --border:#1f2937;
  --primary:#60a5fa; --accent:#34d399; --danger:#f87171; --warn:#fbbf24;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:ui-sans-serif,system-ui,"Segoe UI",Tahoma,Arial;
  background:var(--bg); color:var(--fg);
}
.container{max-width:1200px;margin:auto;padding:16px}
.header{
  display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
  margin-bottom:12px
}
.badge{padding:.25rem .5rem;border:1px solid var(--border);border-radius:8px;background:var(--card)}
.controls{display:flex;gap:8px;flex-wrap:wrap}
button,.btn{
  background:var(--primary); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer;
}
button.secondary{background:var(--accent)}
button.warn{background:var(--warn)}
button.danger{background:var(--danger)}
button.ghost{background:transparent;color:var(--fg);border:1px solid var(--border)}
button:disabled{opacity:.5;cursor:not-allowed}
.card{
  background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:12px
}
.grid{display:grid;gap:10px}
.grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
.grid.cols-6{grid-template-columns:repeat(6,minmax(0,1fr))}
.grid.cols-8{grid-template-columns:repeat(8,minmax(0,1fr))}
input,select,textarea{
  width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:transparent; color:var(--fg)
}
label{font-size:.9rem;color:var(--muted)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.flex{display:flex;gap:8px;align-items:center}
.spacer{flex:1}
.table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px}
table{width:100%;border-collapse:separate;border-spacing:0;min-width:1000px}
thead th{
  position:sticky; top:0; background:var(--card); border-bottom:1px solid var(--border);
  text-align:inherit; padding:10px; font-weight:600
}
tbody td{border-bottom:1px solid var(--border); padding:8px}
tfoot td{background:var(--card); font-weight:700; padding:10px; border-top:2px solid var(--border)}
.num{text-align:end}
.small{font-size:.85rem;color:var(--muted)}
hr{border:none;border-top:1px solid var(--border);margin:10px 0}
.kpi{display:flex; gap:12px; flex-wrap:wrap}
.kpi .box{flex:1; min-width:220px; background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px}
.kpi .val{font-size:1.25rem;font-weight:700}
footer{margin:24px 0 8px;color:var(--muted);font-size:.85rem;text-align:center}
.switch{
  border:1px solid var(--border); border-radius:10px; padding:6px 10px; background:var(--card); cursor:pointer
}
@media (max-width:720px){
  .grid.cols-6{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid.cols-8{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="row">
      <div class="badge" id="appTitle">حساب ربح المقاول</div>
      <div class="badge" id="projectNameBadge"></div>
    </div>
    <div class="controls">
      <button class="switch" id="langToggle">EN</button>
      <button class="switch" id="themeToggle">🌙</button>
      <select id="currencySelect" class="switch">
        <option value="SAR">SAR ﷼</option>
        <option value="USD">USD $</option>
        <option value="EUR">EUR €</option>
      </select>
      <button class="switch" id="rateRefresh">تحديث سعر الصرف</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="flex">
        <label class="small" id="lblProject">اسم المشروع</label>
        <input id="projectName" placeholder="مثال: توريد مواد كهربائية"/>
      </div>
      <div class="flex">
        <label class="small" id="lblVatRate">نسبة الضريبة %</label>
        <input id="vatRate" type="number" step="0.01" min="0" value="15"/>
      </div>
      <div class="spacer"></div>
      <div class="flex">
        <button id="downloadTemplate" class="ghost">تنزيل قالب Excel</button>
        <input type="file" id="excelInput" accept=".xlsx,.xls" style="display:none"/>
        <button id="importExcel" class="ghost">استيراد Excel</button>
      </div>
    </div>
    <hr/>
    <div class="grid cols-8">
      <div>
        <label id="lblItem">اسم البند</label>
        <input id="itemName" placeholder="كيبل نحاسي 16مم"/>
      </div>
      <div>
        <label id="lblUnit">الوحدة</label>
        <select id="itemUnit">
          <option value="قطعة">قطعة</option>
          <option value="متر">متر</option>
          <option value="طن">طن</option>
        </select>
      </div>
      <div>
        <label id="lblQty">الكمية</label>
        <input id="itemQty" type="number" min="0" step="1" value="1"/>
      </div>
      <div>
        <label id="lblCostUnit">سعر التكلفة/وحدة</label>
        <input id="itemCost" type="number" min="0" step="0.01" value="0"/>
      </div>
      <div>
        <label id="lblPct">النسبة %</label>
        <input id="itemPct" type="number" min="0" max="99.99" step="0.01" value="25"/>
      </div>
      <div>
        <label id="lblDiscount">الخصم</label>
        <div class="row">
          <input id="itemDiscount" type="number" min="0" step="0.01" value="0"/>
          <select id="itemDiscountType" style="max-width:90px">
            <option value="amount">مبلغ</option>
            <option value="percent">%</option>
          </select>
        </div>
      </div>
      <div>
        <label id="lblExtra">مصاريف إضافية</label>
        <div class="row">
          <input id="itemExtra" type="number" min="0" step="0.01" value="0"/>
          <select id="itemExtraType" style="max-width:120px">
            <option value="total">إجمالي</option>
            <option value="perunit">لكل وحدة</option>
          </select>
        </div>
      </div>
      <div>
        <label id="lblMethod">طريقة الحسبة</label>
        <select id="itemMethod">
          <option value="costplus">كوست بلس</option>
          <option value="margin">ميرج</option>
        </select>
      </div>
      <div style="grid-column:1/-1">
        <div class="row">
          <div class="flex">
            <input id="itemVat" type="checkbox" checked/>
            <label for="itemVat" id="lblItemVat">تطبيق ضريبة VAT على هذا البند</label>
          </div>
          <div class="spacer"></div>
          <input id="itemNotes" placeholder="ملاحظات (اختياري)" style="max-width:420px"/>
          <button id="addItem" class="secondary">إضافة بند</button>
          <button id="calcAll" class="">احسب</button>
        </div>
      </div>
    </div>
  </div>

  <div class="kpi">
    <div class="box">
      <div id="kpiCostLbl" class="small">إجمالي التكلفة</div>
      <div id="kpiCost" class="val">0</div>
    </div>
    <div class="box">
      <div id="kpiProfitLbl" class="small">إجمالي الربح</div>
      <div id="kpiProfit" class="val">0</div>
    </div>
    <div class="box">
      <div id="kpiPriceLbl" class="small">إجمالي السعر النهائي</div>
      <div id="kpiPrice" class="val">0</div>
    </div>
  </div>

  <div class="row" style="margin:8px 0">
    <div class="flex">
      <button id="exportExcel" class="ghost">تصدير Excel</button>
      <button id="exportPDF" class="ghost">تصدير PDF</button>
      <button id="printReport" class="ghost">طباعة التقرير</button>
    </div>
    <div class="spacer"></div>
    <div class="flex">
      <button id="clearAll" class="danger">مسح الكل</button>
      <span class="small" id="rateInfo"></span>
    </div>
  </div>

  <div class="table-wrap card">
    <table id="itemsTable">
      <thead>
        <tr>
          <th>#</th>
          <th id="thItem">البند</th>
          <th id="thUnit">الوحدة</th>
          <th id="thQty" class="num">الكمية</th>
          <th id="thCostUnit" class="num">التكلفة/وحدة</th>
          <th id="thTotalCost" class="num">إجمالي التكلفة</th>
          <th id="thPct" class="num">% الربح</th>
          <th id="thDiscount" class="num">الخصم</th>
          <th id="thExtra" class="num">مصاريف</th>
          <th id="thMethod">الطريقة</th>
          <th id="thVat">VAT</th>
          <th id="thProfit" class="num">الربح</th>
          <th id="thPrice" class="num">السعر النهائي</th>
          <th id="thNotes">ملاحظات</th>
          <th id="thActions">إجراءات</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="5" class="num">الإجماليات</td>
          <td class="num" id="tTotalCost">0</td>
          <td></td>
          <td class="num" id="tTotalDiscount">0</td>
          <td class="num" id="tTotalExtra">0</td>
          <td></td><td></td>
          <td class="num" id="tTotalProfit">0</td>
          <td class="num" id="tTotalPrice">0</td>
          <td></td><td></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="card">
    <canvas id="chartBar" height="90"></canvas>
    <hr/>
    <canvas id="chartPie" height="90"></canvas>
  </div>

  <footer id="footerNote">تم الحفظ تلقائياً في المتصفح.</footer>
</div>

<script>
/* ====== i18n ====== */
const i18n = {
  ar: {
    title:'حساب ربح المقاول',
    project:'اسم المشروع',
    vatRate:'نسبة الضريبة %',
    downloadTpl:'تنزيل قالب Excel',
    import:'استيراد Excel',
    item:'اسم البند', unit:'الوحدة', qty:'الكمية', costUnit:'سعر التكلفة/وحدة',
    pct:'النسبة %', discount:'الخصم', extra:'مصاريف إضافية', method:'طريقة الحسبة',
    costplus:'كوست بلس', margin:'ميرج', notes:'ملاحظات', addItem:'إضافة بند', calc:'احسب',
    kpiCost:'إجمالي التكلفة', kpiProfit:'إجمالي الربح', kpiPrice:'إجمالي السعر النهائي',
    exportX:'تصدير Excel', exportP:'تصدير PDF', print:'طباعة التقرير', clearAll:'مسح الكل',
    th:{item:'البند', unit:'الوحدة', qty:'الكمية', costUnit:'التكلفة/وحدة', totalCost:'إجمالي التكلفة',
        pct:'% الربح', discount:'الخصم', extra:'مصاريف', method:'الطريقة', vat:'VAT',
        profit:'الربح', price:'السعر النهائي', notes:'ملاحظات', actions:'إجراءات'},
    itemVat:'تطبيق ضريبة VAT على هذا البند',
    amount:'مبلغ', percent:'%', extraTotal:'إجمالي', extraPerUnit:'لكل وحدة',
    delete:'حذف', langBtn:'EN', themeMoon:'🌙', themeSun:'☀️',
    totals:'الإجماليات', saved:'تم الحفظ تلقائياً في المتصفح.', rateBtn:'تحديث سعر الصرف',
    rateInfo:(b, r)=>`العملة: ${b} | سعر التحويل: ${r.toFixed(4)}`
  },
  en: {
    title:'Contractor Profit Calculator',
    project:'Project name',
    vatRate:'VAT rate %',
    downloadTpl:'Download Excel template',
    import:'Import Excel',
    item:'Item name', unit:'Unit', qty:'Quantity', costUnit:'Cost / Unit',
    pct:'Margin %', discount:'Discount', extra:'Extra Costs', method:'Method',
    costplus:'Cost Plus', margin:'Margin', notes:'Notes', addItem:'Add Item', calc:'Calculate',
    kpiCost:'Total Cost', kpiProfit:'Total Profit', kpiPrice:'Total Final Price',
    exportX:'Export Excel', exportP:'Export PDF', print:'Print report', clearAll:'Clear All',
    th:{item:'Item', unit:'Unit', qty:'Qty', costUnit:'Cost/Unit', totalCost:'Total Cost',
        pct:'% Profit', discount:'Discount', extra:'Extra', method:'Method', vat:'VAT',
        profit:'Profit', price:'Final Price', notes:'Notes', actions:'Actions'},
    itemVat:'Apply VAT to this item',
    amount:'Amount', percent:'%', extraTotal:'Total', extraPerUnit:'Per unit',
    delete:'Delete', langBtn:'ع', themeMoon:'🌙', themeSun:'☀️',
    totals:'Totals', saved:'Auto-saved locally.', rateBtn:'Refresh rate',
    rateInfo:(b, r)=>`Currency: ${b} | Rate: ${r.toFixed(4)}`
  }
};

/* ====== State ====== */
let state = {
  lang: localStorage.getItem('lang') || 'ar',
  theme: localStorage.getItem('theme') || 'light',
  currency: localStorage.getItem('currency') || 'SAR',
  baseCurrency: 'SAR',
  rate: Number(localStorage.getItem('rate') || '1'),
  vatRate: Number(localStorage.getItem('vatRate') || '15'),
  projectName: localStorage.getItem('projectName') || '',
  items: JSON.parse(localStorage.getItem('items') || '[]')
};

// demo items on first use
if (!localStorage.getItem('items')) {
  state.items = [
    {id: uid(), name:'كيبل نحاسي 16مم', unit:'متر', qty:100, cost:8.50, pct:25, discount:0, discountType:'amount', extra:0, extraType:'total', method:'costplus', vat:true, notes:''},
    {id: uid(), name:'قاطع تيار 100A', unit:'قطعة', qty:10, cost:55, pct:20, discount:5, discountType:'percent', extra:2, extraType:'perunit', method:'margin', vat:true, notes:''}
  ];
}

/* ====== Helpers ====== */
function uid(){ return Math.random().toString(36).slice(2,9); }
function fmt(n){ return (isFinite(n)? Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) : '0.00'); }
function money(n){ return fmt(n); }
function save(){ localStorage.setItem('items',JSON.stringify(state.items));
  localStorage.setItem('lang',state.lang);
  localStorage.setItem('theme',state.theme);
  localStorage.setItem('currency',state.currency);
  localStorage.setItem('rate',String(state.rate));
  localStorage.setItem('vatRate',String(state.vatRate));
  localStorage.setItem('projectName',state.projectName);
  document.getElementById('footerNote').textContent = t().saved;
}
function t(){ return i18n[state.lang]; }
function setDir(){ document.documentElement.dir = (state.lang==='ar'?'rtl':'ltr'); document.documentElement.lang = state.lang; }

/* ====== Currency Rates ====== */
async function fetchRate(){
  // convert from base (SAR) to selected currency
  try{
    if (state.currency === state.baseCurrency){ state.rate = 1; save(); updateRateInfo(); return; }
    const res = await fetch(`https://api.exchangerate.host/latest?base=${state.baseCurrency}&symbols=${state.currency}`);
    const data = await res.json();
    const r = data?.rates?.[state.currency];
    state.rate = (typeof r === 'number' && r>0) ? r : 1;
  }catch(e){ state.rate = 1; }
  save(); updateRateInfo(); render();
}
function updateRateInfo(){
  const info = document.getElementById('rateInfo');
  info.textContent = t().rateInfo(`${state.baseCurrency}→${state.currency}`, state.rate);
}

/* ====== Calculations ====== */
function adjustedCost(item){
  const qty = Number(item.qty)||0, cost = Number(item.cost)||0;
  let base = cost * qty;
  const extra = Number(item.extra)||0;
  const extraAdd = (item.extraType==='perunit') ? extra * qty : extra;
  // discount per unit or percent
  let discountVal = Number(item.discount)||0;
  if (item.discountType==='percent'){
    discountVal = base * (discountVal/100);
  }
  base = base + extraAdd - discountVal;
  return Math.max(base,0);
}
function calcItem(item){
  const vatRate = (Number(state.vatRate)||0)/100;
  const adj = adjustedCost(item);
  const pct = Math.max(0, Number(item.pct)||0)/100;

  if (item.method==='margin'){
    if (pct>=1){ return {profit:0, price:adj, totalCost: item.cost*item.qty, discountVal:0, extraVal:0, valid:false}; }
    const price = adj/(1-pct);
    const profit = price - adj;
    const withVat = item.vat ? price*(1+vatRate) : price;
    return {profit, price:withVat, totalCost:item.cost*item.qty, valid:true};
  }else{ // cost plus
    const profit = adj*pct;
    const price = adj + profit;
    const withVat = item.vat ? price*(1+vatRate) : price;
    return {profit, price:withVat, totalCost:item.cost*item.qty, valid:true};
  }
}

/* ====== Render ====== */
function render(){
  // header texts / labels
  document.getElementById('appTitle').textContent = t().title;
  document.getElementById('lblProject').textContent = t().project;
  document.getElementById('lblVatRate').textContent = t().vatRate;
  document.getElementById('downloadTemplate').textContent = t().downloadTpl;
  document.getElementById('importExcel').textContent = t().import;

  document.getElementById('lblItem').textContent = t().item;
  document.getElementById('lblUnit').textContent = t().unit;
  document.getElementById('lblQty').textContent = t().qty;
  document.getElementById('lblCostUnit').textContent = t().costUnit;
  document.getElementById('lblPct').textContent = t().pct;
  document.getElementById('lblDiscount').textContent = t().discount;
  document.getElementById('lblExtra').textContent = t().extra;
  document.getElementById('lblMethod').textContent = t().method;
  document.getElementById('lblItemVat').textContent = t().itemVat;

  document.getElementById('addItem').textContent = t().addItem;
  document.getElementById('calcAll').textContent = t().calc;

  document.getElementById('kpiCostLbl').textContent = t().kpiCost;
  document.getElementById('kpiProfitLbl').textContent = t().kpiProfit;
  document.getElementById('kpiPriceLbl').textContent = t().kpiPrice;

  document.getElementById('exportExcel').textContent = t().exportX;
  document.getElementById('exportPDF').textContent = t().exportP;
  document.getElementById('printReport').textContent = t().print;
  document.getElementById('clearAll').textContent = t().clearAll;

  // table headers
  document.getElementById('thItem').textContent = t().th.item;
  document.getElementById('thUnit').textContent = t().th.unit;
  document.getElementById('thQty').textContent = t().th.qty;
  document.getElementById('thCostUnit').textContent = t().th.costUnit;
  document.getElementById('thTotalCost').textContent = t().th.totalCost;
  document.getElementById('thPct').textContent = t().th.pct;
  document.getElementById('thDiscount').textContent = t().th.discount;
  document.getElementById('thExtra').textContent = t().th.extra;
  document.getElementById('thMethod').textContent = t().th.method;
  document.getElementById('thVat').textContent = t().th.vat;
  document.getElementById('thProfit').textContent = t().th.profit;
  document.getElementById('thPrice').textContent = t().th.price;
  document.getElementById('thNotes').textContent = t().th.notes;
  document.getElementById('thActions').textContent = t().th.actions;

  document.getElementById('langToggle').textContent = t().langBtn;
  document.getElementById('rateRefresh').textContent = t().rateBtn;

  // fields
  document.getElementById('vatRate').value = state.vatRate;
  document.getElementById('projectName').value = state.projectName;
  document.getElementById('currencySelect').value = state.currency;
  document.getElementById('themeToggle').textContent = state.theme==='dark'? t().themeSun : t().themeMoon;

  // project badge
  document.getElementById('projectNameBadge').textContent = state.projectName || '';

  // rows
  const tbody = document.querySelector('#itemsTable tbody');
  tbody.innerHTML = '';
  let sumCost=0, sumProfit=0, sumPrice=0, sumQty=0, sumDisc=0, sumExtra=0;

  state.items.forEach((it,idx)=>{
    const res = calcItem(it);
    const adj = adjustedCost(it);
    const totalCost = (Number(it.cost)||0) * (Number(it.qty)||0);
    sumCost += totalCost; sumQty += Number(it.qty)||0;
    sumProfit += res.valid ? res.profit : 0;
    sumPrice += res.valid ? res.price : adj;
    // approx totals for shown columns:
    // discount value for summary (display only, not column per se)
    // compute discount as applied:
    let discVal = 0;
    const base = totalCost;
    if (it.discountType==='percent'){ discVal = base * ((Number(it.discount)||0)/100); }
    else { discVal = Number(it.discount)||0; }
    sumDisc += Math.max(discVal,0);
    const extraVal = it.extraType==='perunit' ? (Number(it.extra)||0) * (Number(it.qty)||0) : (Number(it.extra)||0);
    sumExtra += Math.max(extraVal,0);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td><input data-k="name" value="${it.name||''}"/></td>
      <td>
        <select data-k="unit">
          ${['قطعة','متر','طن','Piece','Meter','Ton'].map(v=>`<option ${it.unit===v?'selected':''}>${v}</option>`).join('')}
        </select>
      </td>
      <td class="num"><input class="num" data-k="qty" type="number" min="0" step="1" value="${it.qty}"/></td>
      <td class="num"><input class="num" data-k="cost" type="number" min="0" step="0.01" value="${it.cost}"/></td>
      <td class="num">${money(totalCost*state.rate)}</td>
      <td class="num"><input class="num" data-k="pct" type="number" min="0" max="99.99" step="0.01" value="${it.pct}"/></td>
      <td class="num">
        <div class="row">
          <input class="num" data-k="discount" type="number" min="0" step="0.01" value="${it.discount}"/>
          <select data-k="discountType" style="max-width:90px">
            <option value="amount" ${it.discountType==='amount'?'selected':''}>${t().amount}</option>
            <option value="percent" ${it.discountType==='percent'?'selected':''}>${t().percent}</option>
          </select>
        </div>
      </td>
      <td class="num">
        <div class="row">
          <input class="num" data-k="extra" type="number" min="0" step="0.01" value="${it.extra}"/>
          <select data-k="extraType" style="max-width:120px">
            <option value="total" ${it.extraType==='total'?'selected':''}>${t().extraTotal}</option>
            <option value="perunit" ${it.extraType==='perunit'?'selected':''}>${t().extraPerUnit}</option>
          </select>
        </div>
      </td>
      <td>
        <select data-k="method">
          <option value="costplus" ${it.method==='costplus'?'selected':''}>${t().costplus}</option>
          <option value="margin" ${it.method==='margin'?'selected':''}>${t().margin}</option>
        </select>
      </td>
      <td class="num"><input type="checkbox" data-k="vat" ${it.vat?'checked':''}/></td>
      <td class="num" style="${res.valid?'':'color:var(--danger)'}">${money((res.valid?res.profit:0)*state.rate)}</td>
      <td class="num" style="${res.valid?'':'color:var(--danger)'}">${money((res.valid?res.price:adj)*state.rate)}</td>
      <td><input data-k="notes" value="${it.notes||''}"/></td>
      <td><button data-action="delete" class="danger">${t().delete}</button></td>
    `;
    // attach listeners for inline edits
    tr.querySelectorAll('input,select').forEach(el=>{
      const k = el.getAttribute('data-k');
      if (!k) return;
      el.addEventListener('input',()=>{
        let v = (el.type==='checkbox') ? el.checked : el.value;
        if (['qty','cost','pct','discount','extra'].includes(k)) v = Number(v);
        it[k] = v;
        save(); render(); drawCharts();
      });
    });
    tr.querySelector('button[data-action="delete"]').addEventListener('click',()=>{
      state.items.splice(idx,1); save(); render(); drawCharts();
    });
    tbody.appendChild(tr);
  });

  // totals row & KPI
  document.getElementById('tTotalCost').textContent = money(sumCost*state.rate);
  document.getElementById('tTotalProfit').textContent = money(sumProfit*state.rate);
  document.getElementById('tTotalPrice').textContent = money(sumPrice*state.rate);
  document.getElementById('tTotalDiscount').textContent = money(sumDisc*state.rate);
  document.getElementById('tTotalExtra').textContent = money(sumExtra*state.rate);

  document.getElementById('kpiCost').textContent = money(sumCost*state.rate);
  document.getElementById('kpiProfit').textContent = money(sumProfit*state.rate);
  document.getElementById('kpiPrice').textContent = money(sumPrice*state.rate);
}

/* ====== Charts ====== */
let barChart, pieChart;
function drawCharts(){
  const labels = state.items.map(x=>x.name||'');
  const costs = state.items.map(x=>(Number(x.cost)||0)*(Number(x.qty)||0)*state.rate);
  const profits = state.items.map(x=> (calcItem(x).valid?calcItem(x).profit:0)*state.rate );

  const barCtx = document.getElementById('chartBar');
  const pieCtx = document.getElementById('chartPie');

  if (barChart) barChart.destroy();
  barChart = new Chart(barCtx, {
    type:'bar',
    data:{ labels, datasets:[
      { label: (state.lang==='ar'?'التكلفة':'Cost'), data:costs },
      { label: (state.lang==='ar'?'الربح':'Profit'), data:profits }
    ]},
    options:{ responsive:true, plugins:{legend:{position:'top'}}}
  });

  if (pieChart) pieChart.destroy();
  const sumProfit = profits.reduce((a,b)=>a+b,0);
  const sumCost = costs.reduce((a,b)=>a+b,0);
  pieChart = new Chart(pieCtx,{
    type:'pie',
    data:{ labels:[(state.lang==='ar'?'إجمالي التكلفة':'Total Cost'),(state.lang==='ar'?'إجمالي الربح':'Total Profit')],
           datasets:[{ data:[sumCost,sumProfit] }] },
    options:{ responsive:true }
  });
}

/* ====== UI Actions ====== */
document.getElementById('addItem').addEventListener('click',()=>{
  const name = document.getElementById('itemName').value.trim();
  const unit = document.getElementById('itemUnit').value;
  const qty = Number(document.getElementById('itemQty').value)||0;
  const cost = Number(document.getElementById('itemCost').value)||0;
  const pct = Number(document.getElementById('itemPct').value)||0;
  const discount = Number(document.getElementById('itemDiscount').value)||0;
  const discountType = document.getElementById('itemDiscountType').value;
  const extra = Number(document.getElementById('itemExtra').value)||0;
  const extraType = document.getElementById('itemExtraType').value;
  const method = document.getElementById('itemMethod').value;
  const vat = document.getElementById('itemVat').checked;
  const notes = document.getElementById('itemNotes').value||'';

  if (!name){ alert(state.lang==='ar'?'أدخل اسم البند':'Enter item name'); return; }
  if (method==='margin' && pct>=100){ alert(state.lang==='ar'?'نسبة الميرج يجب أن تكون أقل من 100%':'Margin must be < 100%'); return; }

  state.items.push({id:uid(), name, unit, qty, cost, pct, discount, discountType, extra, extraType, method, vat, notes});
  save(); render(); drawCharts();
  // reset quick inputs
  document.getElementById('itemName').value='';
  document.getElementById('itemNotes').value='';
});

document.getElementById('calcAll').addEventListener('click',()=>{ render(); drawCharts(); });

document.getElementById('clearAll').addEventListener('click',()=>{
  if (!confirm(state.lang==='ar'?'متأكد من مسح جميع البنود؟':'Clear all items?')) return;
  state.items = []; save(); render(); drawCharts();
});

document.getElementById('projectName').addEventListener('input', (e)=>{ state.projectName = e.target.value; save(); render(); });

document.getElementById('vatRate').addEventListener('input',(e)=>{
  const v = Number(e.target.value)||0; state.vatRate = v; save(); render(); drawCharts();
});

/* ====== Lang & Theme ====== */
document.getElementById('langToggle').addEventListener('click',()=>{
  state.lang = state.lang==='ar'?'en':'ar';
  save(); setDir(); render(); drawCharts();
});
document.getElementById('themeToggle').addEventListener('click',()=>{
  state.theme = state.theme==='dark'?'light':'dark';
  if (state.theme==='dark') document.documentElement.classList.add('dark');
  else document.documentElement.classList.remove('dark');
  save(); render(); drawCharts();
});

/* ====== Currency ====== */
document.getElementById('currencySelect').addEventListener('change',(e)=>{
  state.currency = e.target.value; save(); fetchRate();
});
document.getElementById('rateRefresh').addEventListener('click', fetchRate);

/* ====== Excel Export / Import ====== */
document.getElementById('downloadTemplate').addEventListener('click', ()=>{
  const headers = [["name","unit","qty","cost","pct","discount","discountType","extra","extraType","method","vat","notes"]];
  const ws = XLSX.utils.aoa_to_sheet(headers);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Template");
  XLSX.writeFile(wb, "contractor_profit_template.xlsx");
});
document.getElementById('importExcel').addEventListener('click', ()=> document.getElementById('excelInput').click());
document.getElementById('excelInput').addEventListener('change', (e)=>{
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = (evt)=>{
    const data = new Uint8Array(evt.target.result);
    const wb = XLSX.read(data, {type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, {defval:''});
    json.forEach(r=>{
      const it = {
        id: uid(),
        name: r.name||'',
        unit: r.unit||'قطعة',
        qty: Number(r.qty)||0,
        cost: Number(r.cost)||0,
        pct: Number(r.pct)||0,
        discount: Number(r.discount)||0,
        discountType: (r.discountType==='percent'?'percent':'amount'),
        extra: Number(r.extra)||0,
        extraType: (r.extraType==='perunit'?'perunit':'total'),
        method: (r.method==='margin'?'margin':'costplus'),
        vat: String(r.vat).toLowerCase()==='false'? false : true,
        notes: r.notes||''
      };
      if (it.name) state.items.push(it);
    });
    save(); render(); drawCharts();
    e.target.value='';
  };
  reader.readAsArrayBuffer(file);
});

document.getElementById('exportExcel').addEventListener('click', ()=>{
  const rows = state.items.map((it)=>{
    const res = calcItem(it);
    const totalCost = (Number(it.cost)||0)*(Number(it.qty)||0);
    return {
      name: it.name, unit: it.unit, qty: it.qty, cost_unit: it.cost, total_cost: totalCost,
      pct: it.pct, discount: it.discount, discountType: it.discountType, extra: it.extra, extraType: it.extraType,
      method: it.method, vat: it.vat, profit: res.valid?res.profit:0, final_price: res.valid?res.price:adjustedCost(it),
      notes: it.notes
    };
  });
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Items");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([
    ['Project', state.projectName],
    ['Currency', state.currency],
    ['Rate', state.rate],
    ['VAT %', state.vatRate]
  ]), "Summary");
  XLSX.writeFile(wb, "contractor_profit.xlsx");
});

/* ====== PDF ====== */
document.getElementById('exportPDF').addEventListener('click', ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l','pt','a4');
  const title = (state.lang==='ar'?'تقرير حسبة ربح المقاول':'Contractor Profit Report');
  doc.setFontSize(14); doc.text(title, 40, 30);
  doc.setFontSize(11);
  doc.text(`${t().project}: ${state.projectName||'-'}`, 40, 50);
  doc.text(t().rateInfo(`${state.baseCurrency}→${state.currency}`, state.rate), 40, 70);
  doc.text(`${t().vatRate}: ${state.vatRate}%`, 40, 90);

  const head = [[ '#', t().th.item, t().th.unit, t().th.qty, t().th.costUnit, t().th.totalCost, t().th.pct, t().th.discount, t().th.extra, t().th.method, t().th.vat, t().th.profit, t().th.price, t().th.notes ]];
  const body = state.items.map((it, idx)=>{
    const res = calcItem(it);
    const totalCost = (Number(it.cost)||0)*(Number(it.qty)||0);
    const price = res.valid?res.price:adjustedCost(it);
    const profit = res.valid?res.profit:0;
    return [
      idx+1, it.name, it.unit, it.qty, money(it.cost), money(totalCost),
      money(it.pct), (it.discountType==='percent'? it.discount+'%': money(it.discount)),
      (it.extraType==='perunit'? (money(it.extra)+'/'+(state.lang==='ar'?'وحدة':'unit')): money(it.extra)),
      (it.method==='margin'? t().margin : t().costplus), (it.vat?'✓':'-'),
      money(profit), money(price), (it.notes||'')
    ];
  });
  doc.autoTable({
    head, body, startY: 110, styles:{fontSize:9},
    headStyles:{fillColor:[37,99,235]}, theme:'grid'
  });

  // totals
  const sum = (arr, f)=>arr.reduce((a,x)=>a+f(x),0);
  const tc = sum(state.items, x=>(Number(x.cost)||0)*(Number(x.qty)||0));
  const tp = sum(state.items, x=> (calcItem(x).valid?calcItem(x).profit:0) );
  const tpr = sum(state.items, x=> (calcItem(x).valid?calcItem(x).price:adjustedCost(x)) );
  const y = doc.lastAutoTable.finalY + 20;
  doc.setFontSize(12);
  doc.text(`${t().kpiCost}: ${money(tc)}`, 40, y);
  doc.text(`${t().kpiProfit}: ${money(tp)}`, 220, y);
  doc.text(`${t().kpiPrice}: ${money(tpr)}`, 400, y);

  doc.save('contractor_profit.pdf');
});

document.getElementById('printReport').addEventListener('click', ()=> window.print());

/* ====== Init ====== */
function applyTheme(){
  if (state.theme==='dark') document.documentElement.classList.add('dark');
  else document.documentElement.classList.remove('dark');
}
function init(){
  applyTheme(); setDir(); render(); drawCharts(); updateRateInfo();
  // set selects
  document.getElementById('currencySelect').value = state.currency;
  // first rate fetch (non-blocking)
  fetchRate();
}
init();
</script>
</body>
</html>