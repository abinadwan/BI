<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <!-- أساسيات -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="app-title">Material Cost Estimator</title>

  <!-- توافق وتحسينات -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="description" content="Material Cost Estimator" />
  <meta name="color-scheme" content="light dark" />


  <!-- أيقونات الموقع -->
  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png" sizes="180x180" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon-167.png" sizes="167x167" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon-152.png" sizes="152x152" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon-120.png" sizes="120x120" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon-76.png"  sizes="76x76" />

  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16.png" />
  <link rel="shortcut icon" href="icons/favicon.ico" />

  <!-- Safari pinned tab (اختياري) -->
  <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#007bff" />
  <meta name="msapplication-TileColor" content="#007bff" />

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.webmanifest" />

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- مكتبات وأسلوب -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">

    <header>
      <div class="top-bar">
        <div class="top-controls">
          <div class="toolbar-group">
            <label for="langToggle" id="lang-label">English</label>
            <label class="toggle-switch">
              <input type="checkbox" id="langToggle" aria-label="Language" />
              <span class="slider"></span>
            </label>
          </div>
          <div class="toolbar-group">
            <label for="themeToggle" id="theme-label">Dark Mode</label>
            <label class="toggle-switch">
              <input type="checkbox" id="themeToggle" aria-label="Dark Mode" />
              <span class="slider"></span>
            </label>
          </div>
          <div class="toolbar-group currency-toolbar">
            <label for="currencySelect" id="currency-label">Currency</label>
            <select id="currencySelect" title="Currency">
              <option value="SAR">SAR</option>
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="GBP">GBP</option>
            </select>
            <button id="refreshRateBtn" class="toolbar-button action-button" type="button">
              <i class="fas fa-sync-alt"></i>
              <span id="refresh-rate-btn">Refresh Rate</span>
            </button>
          </div>
        </div>
        <div class="currency-meta">
          <small id="rateInfo" class="currency-rate-info"></small>
          <div id="rate-error-message"></div>
        </div>
      </div>

      <div class="logo-container">
        <img src="logo2.png" alt="Logo" />
        <h1 class="service-name">Material Cost Estimator</h1>
      </div>
    </header>

    <!-- Tabs -->
    <nav class="ax-tabs-nav" dir="rtl" aria-label="مراحل التطبيق" role="tablist">
      <button type="button" class="ax-tab" id="tab-stage1" role="tab" data-target="stage1" aria-controls="panel-stage1" aria-selected="true">المرحلة ١: تفاصيل المشروع</button>
      <button type="button" class="ax-tab" id="tab-stage2" role="tab" data-target="stage2" aria-controls="panel-stage2" aria-selected="false">المرحلة ٢: البنود</button>
      <button type="button" class="ax-tab" id="tab-stage3" role="tab" data-target="stage3" aria-controls="panel-stage3" aria-selected="false">المرحلة ٣: التقارير</button>
      <button type="button" class="ax-tab" id="tab-stage4" role="tab" data-target="stage4" aria-controls="panel-stage4" aria-selected="false">المرحلة ٤: لوحة المؤشرات</button>
    </nav>

    <!-- Panel 1 -->
    <div class="ax-tabs-panel ax-active" id="panel-stage1" role="tabpanel" aria-labelledby="tab-stage1" data-tab="stage1">
      <section class="controls-container">
        <h2><span id="project-details-title">Project Details</span></h2>
        <div class="controls-grid">
          <div class="form-group">
            <label for="projectName" id="project-name-label">Project Name</label>
            <input type="text" id="projectName" placeholder="Enter project name" />
          </div>
          <div class="form-group d-none">
            <label for="vatRate" id="vat-rate-label">VAT Rate %</label>
            <input type="number" id="vatRate" value="15" min="0" step="0.01" placeholder="15" />
          </div>
          <div class="form-group">
            <label for="projectDesc" id="project-desc-label">Project Description</label>
            <textarea id="projectDesc" rows="3" placeholder="Short project description"></textarea>
          </div>
        </div>
      </section>
    </div>

    <!-- Panel 2 -->
    <div class="ax-tabs-panel" id="panel-stage2" role="tabpanel" aria-labelledby="tab-stage2" data-tab="stage2" hidden>
      <section class="controls-container">
        <h2><span id="item-management-title">Item Management</span></h2>
        <div class="button-group">
          <button id="addItemBtn" class="action-button" type="button"><i class="fas fa-plus"></i> <span id="add-item-btn">Add Item</span></button>
          <button id="clearAllBtn" class="action-button delete-btn" type="button"><i class="fas fa-trash-alt"></i> <span id="clear-all-btn">Clear All</span></button>
          <button id="downloadTemplateBtn" class="action-button" type="button"><i class="fas fa-download"></i> <span id="download-template-btn">Download Excel Template</span></button>
          <input type="file" id="importExcelInput" accept=".xlsx, .xls" class="d-none" aria-hidden="true" />
          <button id="importExcelBtn" class="action-button" type="button"><i class="fas fa-file-import"></i> <span id="import-excel-btn">Import Excel</span></button>
        </div>
      </section>

      <section class="table-container">
        <table>
          <thead>
            <tr id="table-headers">
              <th>#</th>
              <th>Item</th>
              <th>Unit</th>
              <th>Qty</th>
              <th>Cost/Unit</th>
              <th>Total Cost</th>
              <th>%</th>
              <th>Discount</th>
              <th>Extra Costs</th>
              <th>Method</th>
              <th>VAT Amount</th>
              <th>Profit</th>
              <th>Final Price</th>
              <th>Notes</th>
              <th class="action-cell">Actions</th>
            </tr>
          </thead>
          <tbody id="itemsTableBody"></tbody>
          <tfoot id="table-footer">
            <tr class="total-row">
              <td colspan="3"><span id="total-label">Totals</span></td>
              <td id="totalQty">0</td>
              <td></td>
              <td id="totalCost">0</td>
              <td></td>
              <td id="totalDiscount">0</td>
              <td id="totalExtra">0</td>
              <td></td>
              <td id="totalVat">0</td>
              <td id="totalProfit">0</td>
              <td id="totalPrice">0</td>
              <td></td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </section>
    </div>

    <!-- Panel 3 -->
    <div class="ax-tabs-panel" id="panel-stage3" role="tabpanel" aria-labelledby="tab-stage3" data-tab="stage3" hidden>
      <section class="controls-container">
        <h2><span id="report-management-title">Report Management</span></h2>
        <div class="button-group">
          <button id="exportExcelBtn" class="action-button" type="button"><i class="fas fa-file-excel"></i> <span id="export-excel-btn">Export Excel</span></button>
          <button id="summaryPdfBtn" class="action-button" type="button"><i class="fas fa-file-pdf"></i> <span id="summary-pdf-btn">Summary Report (PDF)</span></button>
          <button id="detailedPdfBtn" class="action-button" type="button"><i class="fas fa-file-pdf"></i> <span id="detailed-pdf-btn">Detailed Report (PDF)</span></button>
          <button id="previewPdfBtn" class="action-button" type="button"><i class="fas fa-eye"></i> <span id="preview-pdf-btn">Preview PDF</span></button>
          <button id="exportPDFBtn" class="action-button" type="button"><i class="fas fa-file-pdf"></i> <span id="export-pdf-btn">Export PDF</span></button>
          <button id="printBtn" class="action-button" type="button"><i class="fas fa-print"></i> <span id="print-btn">Print Report</span></button>
        </div>

        <div class="pdf-options-grid" id="pdfOptions">
          <div class="form-group">
            <label id="pdf-options-title">PDF Options</label>
            <div class="pdf-options-row">
              <label><input type="checkbox" id="optShowHeader" checked> <span id="show-header-label">Show Header</span></label>
              <label><input type="checkbox" id="optShowFooter" checked> <span id="show-footer-label">Show Footer</span></label>
              <label><input type="checkbox" id="optShowLogo" checked> <span id="show-logo-label">Show Logo</span></label>
              <label><input type="checkbox" id="optShowTotals" checked> <span id="show-totals-label">Show Totals Row</span></label>
              <label><input type="checkbox" id="optEmbedCharts" checked> <span id="embed-charts-label">Embed Charts</span></label>
            </div>
          </div>
          <div class="form-group">
            <label for="optOrientation" id="orientation-label">Orientation</label>
            <select id="optOrientation">
              <option value="landscape" selected id="orientation-landscape">Landscape</option>
              <option value="portrait" id="orientation-portrait">Portrait</option>
            </select>
          </div>
          <div class="form-group">
            <label for="optColumns" id="include-columns-label">Columns</label>
            <select id="optColumns" multiple size="8">
              <option value="#">#</option>
              <option value="name">Item</option>
              <option value="unit">Unit</option>
              <option value="quantity">Qty</option>
              <option value="costPerUnit">Cost/Unit</option>
              <option value="totalCost">Total Cost</option>
              <option value="pct">%</option>
              <option value="discount">Discount</option>
              <option value="extra">Extra Costs</option>
              <option value="method">Method</option>
              <option value="vatAmount">VAT Amount</option>
              <option value="profit">Profit</option>
              <option value="finalPrice">Final Price</option>
              <option value="notes">Notes</option>
            </select>
          </div>
        </div>

        <div id="pdf-preview" class="pdf-preview d-none" aria-live="polite"></div>
      </section>
    </div>

    <!-- Panel 4 -->
    <div class="ax-tabs-panel" id="panel-stage4" role="tabpanel" aria-labelledby="tab-stage4" data-tab="stage4" hidden>
      <section class="charts-container">
        <h2><span id="charts-title">Charts</span></h2>
        <div id="chart-container">
          <div class="chart-box">
            <canvas id="costProfitBarChart"></canvas>
          </div>
          <div class="chart-box">
            <canvas id="costProfitPieChart"></canvas>
          </div>
        </div>
      </section>
    </div>

    <div class="footer">
      <span id="saved-message" class="saved-message"></span>
    </div>
  </div>

  <!-- Modal -->
  <div id="itemModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-content">
      <span class="close-btn" id="closeModalBtn" aria-label="Close">&times;</span>
      <h3 id="modal-title">Add New Item</h3>

      <div class="form-group">
        <label for="itemNameModal" id="item-name-label-modal">Item Name</label>
        <input type="text" id="itemNameModal" required />
        <div class="inline-error" id="nameErrorModal"></div>
      </div>

      <div class="form-group">
        <label for="itemUnitModal" id="unit-label-modal">Unit</label>
        <select id="itemUnitModal"></select>
      </div>

      <div class="form-group">
        <label for="itemQuantityModal" id="qty-label-modal">Quantity</label>
        <input type="text" id="itemQuantityModal" class="numeric-input" inputmode="decimal" />
      </div>

      <div class="form-group">
        <label for="itemCostModal" id="cost-label-modal">Cost Per Unit</label>
        <input type="text" id="itemCostModal" class="numeric-input" inputmode="decimal" />
      </div>

      <div class="form-group">
        <label for="itemPctModal" id="pct-label-modal">Percentage %</label>
        <input type="text" id="itemPctModal" class="numeric-input" inputmode="decimal" />
        <div class="inline-error" id="pctErrorModal"></div>
      </div>

      <div class="form-group">
        <label for="itemDiscountModal" id="discount-label-modal">Discount</label>
        <input type="text" id="itemDiscountModal" class="numeric-input" inputmode="decimal" />
        <select id="itemDiscountTypeModal" aria-label="Discount Type"></select>
      </div>

      <div class="form-group">
        <label for="itemExtraModal" id="extra-label-modal">Extra Costs</label>
        <input type="text" id="itemExtraModal" class="numeric-input" inputmode="decimal" />
        <select id="itemExtraTypeModal" aria-label="Extra Type"></select>
      </div>

      <div class="form-group">
        <label for="itemMethodModal" id="method-label-modal">Method</label>
        <select id="itemMethodModal"></select>
      </div>

      <div class="form-group">
        <input type="checkbox" id="itemVatModal" />
        <label for="itemVatModal" id="vat-label-modal">Apply VAT</label>
      </div>

      <div class="form-group">
        <label for="itemNotesModal" id="notes-label-modal">Notes</label>
        <input type="text" id="itemNotesModal" />
      </div>

      <button id="saveItemBtn" class="mt-15" type="button"><span id="save-item-btn-text">Save Item</span></button>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>

  <!-- App -->
  <script src="script.js"></script>
  <script src="pdf.js"></script>

  <!-- سكربت صغير لتغيير theme-color حسب الثيم/النظام (لا يغيّر منطق تطبيقك) -->
  <script>
    (function () {
      function setThemeColor(hex) {
        let tag = document.querySelector('meta[name="theme-color"]');
        if (!tag) {
          tag = document.createElement('meta');
          tag.name = 'theme-color';
          document.head.appendChild(tag);
        }
        tag.setAttribute('content', hex);
      }

      // حسب تفضيل النظام
      const media = window.matchMedia('(prefers-color-scheme: dark)');
      function applySystemThemeColor() {
        const isDarkBySystem = media.matches;
        // لو عندك كلاس .dark على <html> يحدد الثيم، خذه في الاعتبار
        const isDarkByClass = document.documentElement.classList.contains('dark');
        const isDark = isDarkByClass || isDarkBySystem;
        setThemeColor(isDark ? '#1a1a1a' : '#007bff');
      }
      applySystemThemeColor();
      if (media.addEventListener) media.addEventListener('change', applySystemThemeColor);
      else media.addListener(applySystemThemeColor);

      // اربط بزر تغيير الثيم الحالي لديك (checkbox)
      window.addEventListener('DOMContentLoaded', function () {
        const toggle = document.getElementById('themeToggle');
        if (!toggle) return;
        const applyByToggle = () => {
          const isDark = document.documentElement.classList.contains('dark') || toggle.checked;
          setThemeColor(isDark ? '#1a1a1a' : '#007bff');
        };
        toggle.addEventListener('change', applyByToggle);
        applyByToggle();
      });
    })();
  </script>
</body>
</html>
